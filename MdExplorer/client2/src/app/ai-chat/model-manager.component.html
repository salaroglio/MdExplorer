<div class="model-manager" #scrollContainer>
  <mat-card class="model-manager-card">
    <mat-card-header>
      <mat-card-title>AI Model Manager</mat-card-title>
      <mat-card-subtitle>
        <span *ngIf="isModelLoaded && currentModel">
          <span *ngIf="currentModel.startsWith('Gemini')">
            <mat-icon inline="true" style="vertical-align: middle;">cloud</mat-icon>
            Connected to: {{ currentModel }}
          </span>
          <span *ngIf="!currentModel.startsWith('Gemini')">
            Local Model: {{ currentModel }}
            <span *ngIf="gpuEnabled" class="gpu-indicator">
              <mat-icon inline="true">memory</mat-icon>
              GPU Enabled ({{ gpuLayerCount }} layers)
            </span>
          </span>
        </span>
        <span *ngIf="!isModelLoaded">
          No model connected (Local or Cloud)
        </span>
      </mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content style="overflow: visible !important;">
      <!-- GPU Information Card -->
      <mat-card *ngIf="gpuInfo" class="gpu-info-card" style="margin-bottom: 20px;">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>memory</mat-icon>
            GPU Status
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="gpu-details">
            <div *ngIf="gpuInfo.isNvidiaGpu">
              <strong>{{ gpuInfo.name }}</strong>
              <mat-chip-list style="display: inline-flex; margin-left: 10px;">
                <mat-chip *ngIf="gpuInfo.isRtxCard" color="accent" selected>
                  <mat-icon>check_circle</mat-icon>
                  RTX
                </mat-chip>
                <mat-chip *ngIf="gpuInfo.isCudaAvailable" color="primary" selected>
                  <mat-icon>check_circle</mat-icon>
                  CUDA {{ gpuInfo.cudaVersion }}
                </mat-chip>
                <mat-chip *ngIf="!gpuInfo.isCudaAvailable" color="warn" selected>
                  <mat-icon>warning</mat-icon>
                  CUDA Not Available
                </mat-chip>
              </mat-chip-list>
              <div style="margin-top: 10px;">
                <span>Memory: {{ gpuInfo.formattedMemory || formatBytes(gpuInfo.memoryBytes) }}</span>
                <span style="margin-left: 20px;">Driver: {{ gpuInfo.driverVersion }}</span>
              </div>
            </div>
            <div *ngIf="!gpuInfo.isNvidiaGpu">
              <mat-icon color="warn">warning</mat-icon>
              No NVIDIA GPU detected - Models will run on CPU
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <div class="actions-bar">
        <button mat-raised-button color="primary" (click)="loadModels()" [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
        <button mat-raised-button color="accent" (click)="editSystemPrompt()" 
                [disabled]="!isModelLoaded || editingSystemPrompt">
          <mat-icon>edit</mat-icon>
          Configure System Prompt
        </button>
        <button mat-raised-button color="warn" (click)="toggleGeminiConfig()">
          <mat-icon>cloud</mat-icon>
          {{ showGeminiConfig ? 'Hide' : 'Configure' }} Gemini API
        </button>
      </div>

      <!-- System Prompt Editor -->
      <mat-card *ngIf="editingSystemPrompt && isModelLoaded" class="system-prompt-editor">
        <mat-card-header>
          <mat-card-title>System Prompt Configuration</mat-card-title>
          <mat-card-subtitle>Define how the AI should behave for model: {{ currentModel }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" style="width: 100%;">
            <mat-label>System Prompt</mat-label>
            <textarea matInput 
                      [(ngModel)]="systemPrompt" 
                      rows="8"
                      placeholder="Enter the system prompt that defines the AI's behavior...">
            </textarea>
            <mat-hint>This prompt will be prepended to every user message to guide the AI's responses</mat-hint>
          </mat-form-field>
        </mat-card-content>
        <mat-card-actions align="end">
          <button mat-button (click)="cancelEditSystemPrompt()">Cancel</button>
          <button mat-raised-button color="primary" (click)="saveSystemPrompt()">
            <mat-icon>save</mat-icon>
            Save System Prompt
          </button>
        </mat-card-actions>
      </mat-card>

      <!-- Gemini API Configuration Card -->
      <mat-card *ngIf="showGeminiConfig" class="gemini-config-card" style="margin: 20px 0;">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>cloud</mat-icon>
            Gemini API Configuration
          </mat-card-title>
          <mat-card-subtitle>
            Configure Google Gemini API for cloud-based AI models
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="!geminiConfigured">
            <mat-form-field appearance="outline" style="width: 100%;">
              <mat-label>Gemini API Key</mat-label>
              <input matInput type="password" [(ngModel)]="geminiApiKey" 
                     placeholder="Enter your Gemini API key">
              <mat-hint>Get your API key from <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a></mat-hint>
            </mat-form-field>
            <div style="margin-top: 16px;">
              <button mat-raised-button color="primary" (click)="saveGeminiApiKey()" 
                      [disabled]="loading || !geminiApiKey.trim()">
                <mat-icon>save</mat-icon>
                Save API Key
              </button>
              <button mat-button (click)="testGeminiApiKey()" 
                      [disabled]="testingApiKey || !geminiApiKey.trim()" 
                      style="margin-left: 8px;">
                <mat-icon>check</mat-icon>
                Test Key
              </button>
            </div>
          </div>
          
          <div *ngIf="geminiConfigured">
            <mat-chip-list style="margin-bottom: 16px;">
              <mat-chip color="primary" selected>
                <mat-icon>check_circle</mat-icon>
                API Key Configured
              </mat-chip>
            </mat-chip-list>
            
            <h4>Available Gemini Models:</h4>
            <div class="models-grid">
              <mat-card *ngFor="let model of geminiModels" class="model-card">
                <mat-card-header>
                  <mat-card-title>{{ model.name }}</mat-card-title>
                  <mat-card-subtitle>
                    Cloud Model | {{ model.inputTokenLimit / 1000 }}K input / {{ model.outputTokenLimit / 1000 }}K output
                  </mat-card-subtitle>
                </mat-card-header>
                
                <mat-card-content>
                  <p class="model-description">{{ model.description }}</p>
                  
                  <mat-chip-list *ngIf="useGemini && selectedGeminiModel === model.id">
                    <mat-chip color="accent" selected>
                      <mat-icon>check_circle</mat-icon>
                      Connected
                    </mat-chip>
                  </mat-chip-list>
                </mat-card-content>
                
                <mat-card-actions>
                  <button mat-raised-button color="primary"
                          *ngIf="!useGemini || selectedGeminiModel !== model.id"
                          (click)="connectGeminiModel(model.id)">
                    <mat-icon>cloud_queue</mat-icon>
                    Connect
                  </button>
                  
                  <button mat-button
                          *ngIf="useGemini && selectedGeminiModel === model.id"
                          (click)="disconnectGemini()">
                    <mat-icon>cloud_off</mat-icon>
                    Disconnect
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>
            
            <div style="margin-top: 16px;">
              <button mat-raised-button color="accent" (click)="editGeminiSystemPrompt()" 
                      [disabled]="editingGeminiSystemPrompt || !useGemini">
                <mat-icon>edit</mat-icon>
                Configure Gemini System Prompt
              </button>
            </div>
            
          </div>
        </mat-card-content>
      </mat-card>
      
      <!-- Gemini System Prompt Editor -->
      <mat-card *ngIf="editingGeminiSystemPrompt && geminiConfigured" class="system-prompt-editor">
        <mat-card-header>
          <mat-card-title>Gemini System Prompt Configuration</mat-card-title>
          <mat-card-subtitle>Define how Gemini AI should behave</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" style="width: 100%;">
            <mat-label>System Prompt</mat-label>
            <textarea matInput 
                      [(ngModel)]="geminiSystemPrompt" 
                      rows="8"
                      placeholder="Enter the system prompt that defines Gemini's behavior...">
            </textarea>
            <mat-hint>This prompt will guide Gemini's responses in all conversations</mat-hint>
          </mat-form-field>
        </mat-card-content>
        <mat-card-actions align="end">
          <button mat-button (click)="cancelEditGeminiSystemPrompt()">Cancel</button>
          <button mat-raised-button color="primary" (click)="saveGeminiSystemPrompt()">
            <mat-icon>save</mat-icon>
            Save Gemini System Prompt
          </button>
        </mat-card-actions>
      </mat-card>

      <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

      <div class="models-grid">
        <mat-card *ngFor="let model of availableModels" class="model-card">
          <mat-card-header>
            <mat-card-title>{{ model.name }}</mat-card-title>
            <mat-card-subtitle>
              {{ model.parameters }} parameters | {{ model.contextLength }} context
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <p class="model-description">{{ model.description }}</p>
            
            <div class="model-info">
              <span class="file-size">Size: {{ formatBytes(model.fileSize) }}</span>
              <mat-chip-list>
                <mat-chip *ngIf="model.isInstalled" color="primary" selected>
                  <mat-icon>check_circle</mat-icon>
                  Installed
                </mat-chip>
                <mat-chip *ngIf="isCurrentModel(model)" color="accent" selected>
                  <mat-icon>memory</mat-icon>
                  Loaded
                </mat-chip>
              </mat-chip-list>
            </div>

            <!-- Download Progress -->
            <div *ngIf="isDownloading(model.id)" class="download-progress">
              <div class="progress-info">
                <span>{{ downloadProgress[model.id].status }}</span>
                <span>{{ downloadProgress[model.id].percentComplete | number:'1.1-1' }}%</span>
              </div>
              <mat-progress-bar 
                mode="determinate" 
                [value]="downloadProgress[model.id].percentComplete">
              </mat-progress-bar>
              <div class="progress-bytes">
                {{ formatBytes(downloadProgress[model.id].bytesDownloaded) }} / 
                {{ formatBytes(downloadProgress[model.id].totalBytes) }}
              </div>
            </div>
          </mat-card-content>
          
          <mat-card-actions>
            <button 
              mat-button 
              color="primary"
              *ngIf="!model.isInstalled && !isDownloading(model.id)"
              (click)="downloadModel(model)">
              <mat-icon>download</mat-icon>
              Download
            </button>
            
            <button 
              mat-button 
              color="accent"
              *ngIf="model.isInstalled && !isCurrentModel(model)"
              (click)="loadModel(model)"
              [disabled]="loading">
              <mat-icon>play_arrow</mat-icon>
              Load
            </button>
            
            <button 
              mat-button 
              color="warn"
              *ngIf="model.isInstalled && !isCurrentModel(model)"
              (click)="deleteModel(model)">
              <mat-icon>delete</mat-icon>
              Delete
            </button>
            
            <button 
              mat-button 
              disabled
              *ngIf="isCurrentModel(model)">
              <mat-icon>check</mat-icon>
              Currently Loaded
            </button>
          </mat-card-actions>
        </mat-card>
      </div>

      <div *ngIf="availableModels.length === 0 && !loading" class="no-models">
        <mat-icon>info</mat-icon>
        <p>No models available</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>