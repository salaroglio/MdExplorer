import { AfterViewInit, ChangeDetectorRef, Component, ElementRef, EventEmitter, Input, NgZone, OnInit, Output, ViewChild } from '@angular/core';
import { MdFile } from '../../models/md-file';
//import { IWorkWithElement } from '../../services/href-interceptor.service';
import { MdFileService } from '../../services/md-file.service';
import { DomSanitizer } from '@angular/platform-browser';

import { MdServerMessagesService } from '../../../signalR/services/server-messages.service';
import { MatDialog } from '@angular/material/dialog';
//import { ConnectionLostComponent } from '../../../signalR/dialogs/connection-lost/connection-lost.component';///dialogs/connection-lost/connection-lost.component


@Component({
  selector: 'app-main-content',
  templateUrl: './main-content.component.html',
  styleUrls: ['./main-content.component.scss']
})
export class MainContentComponent implements OnInit { // Removed AfterViewInit
  @ViewChild('myBelovedIframe') el: ElementRef;
  public classForContent: string = "hundredPercentContent"; // Set to a default, assuming it fills its container

  mdFile: MdFile;
  html: string;
  htmlSource: string = '../welcome.html';

  //helloWorld: IWorkWithElement = (msg) => {
  //  alert('this is the callback');
  //};


  public _HideIFrame = false;

  constructor(
    private service: MdFileService,
    private sanitizer: DomSanitizer,
    private monitorMDService: MdServerMessagesService,
    public dialog: MatDialog,
    private ref: ChangeDetectorRef,
  ) {
    console.log("MainContentComponent constructor");
    this.monitorMDService.addMarkdownFileListener(this.markdownFileIsChanged, this);
  }

  ngOnInit(): void {

    this.service.selectedMdFileFromSideNav.subscribe(_ => {
      this.callMdExplorerController(_);
    });
    this.service.selectedMdFileFromToolbar.subscribe(_ => {
      let current = _[0];
      if (current != undefined) {
        this.callMdExplorerController(current);
      }
    });
    // Removed subscription to this.service.whatDisplayForToolbar
  }
  private callMdExplorerController(node:  MdFile) {
    if (node != null && node.relativePath != undefined) {
      let dateTime = new Date().getTime() / 1000;
      this.htmlSource = '../api/mdexplorer/' + node.relativePath + '?time=' + dateTime + "&connectionId=" + this.monitorMDService.connectionId;
    }
  }

  private markdownFileIsChanged(data: any, objectThis: MainContentComponent) {
    console.log('üìÑ [MainContent] markdownFileIsChanged received:', data);
    
    let dateTime = new Date().getTime() / 1000;
    objectThis.service.navigationArray = [];
    objectThis.service.setSelectedMdFileFromServer(data);
    
    // Use relativePath or path (handle both uppercase and lowercase)
    const relativePath = data.relativePath || data.RelativePath || data.path || data.Path;
    if (!relativePath) {
      console.error('‚ùå [MainContent] No relative path found in data:', data);
      return;
    }
    
    // Ensure forward slashes for URL
    const urlPath = relativePath.replace(/\\/g, '/');
    objectThis.htmlSource = '../api/mdexplorer' + urlPath + '?time=' + dateTime + "&connectionId=" + objectThis.monitorMDService.connectionId;
    console.log('‚úÖ [MainContent] Updated htmlSource to:', objectThis.htmlSource);
  }



}
