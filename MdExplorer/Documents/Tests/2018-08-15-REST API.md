# OMNIA REST API
This document provides the latest class diagrams for the following objects:
+ Camera
+ Detection Unit
+ Detector
+ Lpr Unit
+ Measure
+ Status
+ Traffic Light Controller
+ Variable Message Sign
+ Vbid Unit
+ Sitation Pubblication
+ Network state

Provides also the following sequence diagrams:
+ Object list
+ Object Status
+ Measurement
+ Events
+ Network State

# Camera class diagram

```plantuml
@startuml
    class "Camera" {
    +String Source
    }


    class "EquipmentParameter" {
    +String Parameter
    +String Value
    }

    class "Equipment" {
    +String Code
    +String Description
    +String GUID
    +String LastUpdateTimeUTC
    +String Model
    +String Status
    +Int32 Subsystem
    +String Type
    +String Uri
    }

    interface "IParameters" {
    }

    class "GeoInfo" {
    +Nullable<Int32> Direction
    +Double Latitude
    +Double Longitude
    +String Projection
    }

"Camera" *-- "EquipmentParameter" : Has Many \nParameters
"Camera" -up-|> "Equipment" : Extends
"Camera" -up-|> "IParameters" : Extends
"Equipment" *-- "GeoInfo" : Has A \nGeoInfo
"IParameters" *-- "EquipmentParameter" : Has Many \nParameters
@enduml
```

# Detection Unit class diagram

```plantuml
@startuml
    class "DetectionUnit" {
    }

    class "EquipmentParameter" {
    +String Parameter
    +String Value
    }

    class "Equipment" {
    +String Code
    +String Description
    +String GUID
    +String LastUpdateTimeUTC
    +String Model
    +String Status
    +Int32 Subsystem
    +String Type
    +String Uri
    }

    interface "IParameters" {
    }

    class "GeoInfo" {
    +Nullable<Int32> Direction
    +Double Latitude
    +Double Longitude
    +String Projection
    }

"DetectionUnit" *-- "EquipmentParameter" : Has Many \nParameters
"DetectionUnit" -up-|> "Equipment" : Extends
"DetectionUnit" -up-|> "IParameters" : Extends
"Equipment" *-- "GeoInfo" : Has A \nGeoInfo
"IParameters" *-- "EquipmentParameter" : Has Many \nParameters
@enduml
```

# Detector class diagram

```plantuml
@startuml
    class "Detector" {
    }

    class "EquipmentParameter" {
    +String Parameter
    +String Value
    }

    class "Equipment" {
    +String Code
    +String Description
    +String GUID
    +String LastUpdateTimeUTC
    +String Model
    +String Status
    +Int32 Subsystem
    +String Type
    +String Uri
    }

    interface "IParameters" {
    }

    class "GeoInfo" {
    +Nullable<Int32> Direction
    +Double Latitude
    +Double Longitude
    +String Projection
    }

"Detector" *-- "EquipmentParameter" : Has Many \nParameters
"Detector" -up-|> "Equipment" : Extends
"Detector" -up-|> "IParameters" : Extends
"Equipment" *-- "GeoInfo" : Has A \nGeoInfo
"IParameters" *-- "EquipmentParameter" : Has Many \nParameters
@enduml
```

# Lpr Unit class diagram
```plantuml
@startuml
    class "LprUnit" {
    }

    class "EquipmentParameter" {
    +String Parameter
    +String Value
    }

    class "Equipment" {
    +String Code
    +String Description
    +String GUID
    +String LastUpdateTimeUTC
    +String Model
    +String Status
    +Int32 Subsystem
    +String Type
    +String Uri
    }

    interface "IParameters" {
    }

    class "GeoInfo" {
    +Nullable<Int32> Direction
    +Double Latitude
    +Double Longitude
    +String Projection
    }

"LprUnit" *-- "EquipmentParameter" : Has Many \nParameters
"LprUnit" -up-|> "Equipment" : Extends
"LprUnit" -up-|> "IParameters" : Extends
"Equipment" *-- "GeoInfo" : Has A \nGeoInfo
"IParameters" *-- "EquipmentParameter" : Has Many \nParameters
@enduml
```

# Measure class diagram

```plantuml
@startuml
    class "Measure" {
    +String MeasureTimeUTC
    }

    class "Datum" {
    +String Group
    +String Key
    +String Value
    }


    class "Sensor" {
    }

"Measure" *-- "Datum" : Has Many \nData
"Measure" *-- "Sensor" : Has Many \nSensors
"Sensor" *-- "Datum" : Has Many \nData
@enduml
```

# Status class diagram

```plantuml
@startuml
    class "Status" {
    +String GUID
    +String LastUpdateTimeUTC
    }

    class "StatusParameter" {
    +String Parameter
    +String Value
    }

    class "Alarm" {
    +Boolean Acknowledged
    +Boolean Blocked
    +String Code
    +String Description
    +String EndTime
    +String GUID
    +String Severity
    +String StartTime
    +String Type
    +String UpdateTime
    }


    class "AlarmParameter" {
    +String Parameter
    +Int32 ProgressId
    +String Value
    }

"Status" *-- "StatusParameter" : Has Many \nStatusParameters
"Status" *-- "Alarm" : Has Many \nAlarms
"Alarm" *-- "AlarmParameter" : Has Many \nAlarmParameters
@enduml
```


# Traffic Light Controller class diagram

```plantuml
@startuml
    class "TrafficLightController" {
    }

    class "EquipmentParameter" {
    +String Parameter
    +String Value
    }

    class "Equipment" {
    +String Code
    +String Description
    +String GUID
    +String LastUpdateTimeUTC
    +String Model
    +String Status
    +Int32 Subsystem
    +String Type
    +String Uri
    }

    interface "IParameters" {
    }

    class "GeoInfo" {
    +Nullable<Int32> Direction
    +Double Latitude
    +Double Longitude
    +String Projection
    }

"TrafficLightController" *-- "EquipmentParameter" : Has Many \nParameters
"TrafficLightController" -up-|> "Equipment" : Extends
"TrafficLightController" -up-|> "IParameters" : Extends
"Equipment" *-- "GeoInfo" : Has A \nGeoInfo
"IParameters" *-- "EquipmentParameter" : Has Many \nParameters
@enduml
```

# Variable Message Sign class diagram

```plantuml
@startuml
    class "VariableMessageSign" {
    }

    class "EquipmentParameter" {
    +String Parameter
    +String Value
    }

    class "Equipment" {
    +String Code
    +String Description
    +String GUID
    +String LastUpdateTimeUTC
    +String Model
    +String Status
    +Int32 Subsystem
    +String Type
    +String Uri
    }

    interface "IParameters" {
    }

    class "GeoInfo" {
    +Nullable<Int32> Direction
    +Double Latitude
    +Double Longitude
    +String Projection
    }

"VariableMessageSign" *-- "EquipmentParameter" : Has Many \nParameters
"VariableMessageSign" -up-|> "Equipment" : Extends
"VariableMessageSign" -up-|> "IParameters" : Extends
"Equipment" *-- "GeoInfo" : Has A \nGeoInfo
"IParameters" *-- "EquipmentParameter" : Has Many \nParameters
@enduml
```

# Vbid Unit class diagram

```plantuml
@startuml
    class "VbidUnit" {
    }

    class "EquipmentParameter" {
    +String Parameter
    +String Value
    }

    class "Equipment" {
    +String Code
    +String Description
    +String GUID
    +String LastUpdateTimeUTC
    +String Model
    +String Status
    +Int32 Subsystem
    +String Type
    +String Uri
    }

    interface "IParameters" {
    }

    class "GeoInfo" {
    +Nullable<Int32> Direction
    +Double Latitude
    +Double Longitude
    +String Projection
    }

"VbidUnit" *-- "EquipmentParameter" : Has Many \nParameters
"VbidUnit" -up-|> "Equipment" : Extends
"VbidUnit" -up-|> "IParameters" : Extends
"Equipment" *-- "GeoInfo" : Has A \nGeoInfo
"IParameters" *-- "EquipmentParameter" : Has Many \nParameters
@enduml
```

# Situation Pubblication class diagram
See [DATEX II version 2.3](http://d2docs.ndwcloud.nu/_static/umlmodel/v2.3/index.htm?goto=4:6:1:659) for further informations.

![SituationRecord](http://d2docs.ndwcloud.nu/_static/umlmodel/v2.3/EARoot/EA4/EA6/EA1/EA660.png)

# Network State class diagram
-- TODO spostare legenda mappa Omnia su DB

Custom thresholds are defined into **misticui.xml** on the MISTIC conf's directory. This configuration will be moved to the MISTIC DB, in this way the configuration is available for both application (MISTIC and OMNIA). \
Nowadays the Omnia Map's legend displays only the default measure's type, it needs to support also the customizations.

**MISTIC**: The Supported Measures are managed on **NetState.class.php** on row **1047**.

**OMNIA**: Needs to be managed also into OMNIA, the Omnia Default Supported Measures are available on **GenericOmniaMap.js** on row **84** (*setNetworkNavigation*).

In the following list, I display the supported customizable measure's types:

+ speed
+ density
+ flow
+ flowLane
+ travelTime
+ admitEquiv
+ admitLocal
+ ctrInd
+ anomLvl
+ congLvl
+ srvcLvl
+ severity
+ mortality
+ injury
+ accidents_est

The following schema displays the structure on DB and as returned on Omnia Server Rest API:

```plantuml
@startuml
    class "NetStateSupportedMeasure" {
    +String MeasureType
    +String UnitOfMeasure
    }


    class "Threshold" {
    +String Color
    +Single Max
    +Single Min
    }

"NetStateSupportedMeasure" *-- "Threshold" : Has Many \nThresholds
@enduml

@startuml
    class "NetState" {
    +String DbfFileUri
    +String MeasureType
    +String ShapeFileUri
    }
@enduml
```

# Third-Party Authentication sequence diagram
The following sequence diagram shows how to get access to OMNIA REST API resources from a Third-Party application.
```plantuml
@startuml
@startuml
hide footbox

skinparam ArrowColor black
skinparam LifeLineBorderColor black
skinparam LifeLineBackgroundColor black
skinparam BackgroundColor white
skinparam NoteBackgroundColor whitesmoke
skinparam ParticipantBackgroundColor #E3E7E9
skinparam ActorBackgroundColor #F29200
skinparam DatabaseBackgroundColor #006BAB
skinparam CollectionsBackgroundColor #E3E7E9
skinparam ActorBorderColor #485258
skinparam ParticipantBorderColor #485258
skinparam CollectionsBorderColor #485258
skinparam DatabaseBorderColor #485258


participant "Third-Party" as LOM #F29200
participant "OAuth2-Autentication\nServer" as AAA 
participant "OMNIA" as OMNIA

group "Authentication"

LOM -> OMNIA: Request
activate LOM
activate OMNIA
OMNIA -> LOM: Response redirect to AAA Server for authentication
deactivate OMNIA
LOM -> AAA: GET /token\ngrant_type=password&\nusername=USERNAME&\npassword=PASSWORD\nclient_id=CLIENT_ID
activate AAA
AAA -> AAA: Validate credentials
AAA -> LOM: Redirect to OMNIA REST API with Access Token
deactivate LOM
note left : Access Token example:\n{  \n   "access_token":"eyJh...",\n   "expires_in":300,\n   "refresh_expires_in":1800,\n   "refresh_token":"eyJhb..",\n   "token_type":"bearer",\n   "id_token":"eyJhb...",\n   "not-before-policy":0,\n   "session_state":"135...",\n   "scope":""\n}
deactivate AAA

end
...

group "Resource Management"
LOM -> OMNIA: Request Resource #1 (with Access Token)
activate LOM
activate OMNIA
OMNIA -> AAA: Check if the Access Token is valid
activate AAA
AAA -> OMNIA: Return successfull validation 
deactivate AAA
OMNIA -> LOM: Return Resource #1
deactivate OMNIA
deactivate LOM
...
LOM -> AAA: Request Refresh Token
activate LOM
activate AAA
note left : When Access Token expires,\nThird-Party must refresh the Token
AAA -> LOM: New Access Token
deactivate AAA
LOM -> OMNIA: Request Resource #2 (with New Access Token)
activate OMNIA
OMNIA -> AAA: Check if the Access Token is valid
activate AAA
AAA -> OMNIA: Return successfull validation 
deactivate AAA
OMNIA -> LOM: Return Resource #2
deactivate OMNIA
deactivate LOM
end

@enduml
```


# Object list sequence diagram

```plantuml
@startuml
skinparam BackgroundColor white
skinparam NoteBackgroundColor whitesmoke

participant "Third-party" as TP #white
participant "OMNIA REST API" as OMNIA #white

TP -[#black]> OMNIA: GET rest/v1/objects/supportedtypes
activate OMNIA
OMNIA -[#green]> TP: Return a collection of element types managed by the system,\nalong with the URI to be used to retrieve the list of objects
note right : Message response in case of error are:\n401 Unauthorized\n500 Internal Server Error
deactivate OMNIA
activate TP
TP -[#black]> OMNIA: GET rest/v1/{ObjectType}s 
deactivate TP
activate OMNIA
OMNIA -[#green]> TP: Response as array of {ObjectType}s\n
deactivate OMNIA

@enduml
```
Example:
```plantuml
@startuml
skinparam BackgroundColor white
skinparam NoteBackgroundColor whitesmoke

participant "Third-party" as TP #white
participant "OMNIA REST API" as OMNIA #white

TP -[#black]> OMNIA: GET rest/v1/objects/supportedtypes
activate OMNIA
OMNIA -[#green]> TP: Return a collection of element types managed by the system,\nalong with the URI to be used to retrieve the list of objects
note left: Example:\n[\n    {\n        "Type": "TRAFFIC_LIGHT_CONTROLLER",\n        "Uri": "http://192.168.55.75:8088/res/v1/trafficlightcontrollers"\n    },\n    {\n        "Type": "DETECTION_UNIT",\n        "Uri": "http://192.168.55.75:8088/rest/v1/detectionunits"\n    },\n    {\n        "Type": "LPR_UNIT",\n        "Uri": "http://192.168.55.75:8088/rest/v1/lprunits"\n    },\n    {\n        "Type": "CAMERA",\n        "Uri": "http://192.168.55.75:8088/rest/v1/cameras"\n    }\n]
note right : Message response in case of error are:\n401 Unauthorized\n500 Internal Server Error
deactivate OMNIA
activate TP
TP -[#black]> OMNIA: GET rest/v1/{ObjectType}s 
deactivate TP
activate OMNIA
OMNIA -[#green]> TP: Response as array of {Object}s\n
note left: [\n   {\n      "Subsystem":0,\n      "GUID":"f0816577-8e29-4c13-9d49-e6f1a7ff2c1f",\n      "Code":"001",\n      "Description":"TEST 001",\n      "Type":"TRAFFIC_LIGHT_CONTROLLER",\n      "Model":"SWARCO - ITC-2 (STCIP)",\n      "Uri":"http://localhost:8088/rest/v1/trafficlightcontrollers\n         /f0816577-8e29-4c13-9d49-e6f1a7ff2c1f?token=111",\n       "Status":"http://localhost:8088/rest/v1/trafficlightcontrollers\n        /f0816577-8e29-4c13-9d49-e6f1a7ff2c1f/status?token=111",\n      "GeoInfo":{\n         "Projection":"EPSG:4326 / WGS 84",\n         "Latitude":45.07136535644531,\n         "Longitude":7.684701919555664\n      },\n      "LastUpdateTimeUTC":"2018-07-03T09:23:09Z"\n   }\n]
deactivate OMNIA

@enduml
```

# Object status sequence diagram

```plantuml
@startuml
skinparam BackgroundColor white
skinparam NoteBackgroundColor whitesmoke

participant "Third-party" as TP #white
participant "OMNIA REST API" as OMNIA #white

TP -[#black]> OMNIA: GET rest/v1/{ObjectType}s/status 
activate OMNIA
OMNIA -[#green]> TP: 200 OK (response also includes an array of {Status})
note right : Message response in case of error are:\n401 Unauthorized\n500 Internal Server Error
deactivate OMNIA

@enduml
```
```plantuml
@startuml
skinparam BackgroundColor white
skinparam NoteBackgroundColor whitesmoke

participant "Third-party" as TP #white
participant "OMNIA REST API" as OMNIA #white

TP -[#black]> OMNIA: GET rest/v1/{ObjectType}s/{guid}/status 
activate OMNIA
OMNIA -[#green]> TP: 200 OK (response also includes an array of {Status})

note right : Message response in case of error are:\n401 Unauthorized\n500 Internal Server Error
deactivate OMNIA

@enduml
```
Example:
```plantuml
@startuml
skinparam BackgroundColor white
skinparam NoteBackgroundColor whitesmoke

participant "Third-party" as TP #white
participant "OMNIA REST API" as OMNIA #white

TP -[#black]> OMNIA: GET rest/v1/{ObjectType}s/status 
activate OMNIA
OMNIA -[#green]> TP: 200 OK (response also includes an array of {Status})

note right : Message response in case of error are:\n401 Unauthorized\n500 Internal Server Error

note left: Example:\n {\n  "LastUpdateTimeUTC": "2017-10-26T12:51:02Z",\n  "StatusParameters": [\n    {\n      "Parameter": "STATUS",\n      "Value": "ON"\n    },\n    {\n      "Parameter": "OPERATING_MODE",\n      "Value": "FORCED"\n    }\n  ],\n  "Alarms": [\n    {\n      "GUID": "b863ebfd-a73a-46af-9533-49e4b22d5298",\n      "Severity": "MEDIUM",\n      "Type": "System",\n      "Code": "CA001",\n      "StartTime": "2018-04-23T12:09:47Z",\n      "UpdateTime": "2018-08-14T14:54:23Z",\n      "Description": "Block Expired",\n      "AlarmParameters": [],\n      "Acknowledged": false,\n      "Blocked": false\n    },\n ]\n}

deactivate OMNIA

@enduml
```


# Measurement sequence diagram

```plantuml
@startuml
skinparam BackgroundColor white
skinparam NoteBackgroundColor whitesmoke

participant "Third-party" as TP #white
participant "OMNIA REST API" as OMNIA #white




TP -[#black]> OMNIA: GET /rest/v1/detectionunits
OMNIA -[#green]> TP: list of detection units, with the guid and the linked detectors
TP -[#black]> OMNIA: For each detectors, ask for the supported measures:\nGET /rest/v1/detectors/{guid}/supportedmeasures
note left : a
OMNIA -[#green]> TP: list of measurestypes supported by the selected detector
TP -[#black]> OMNIA: GET /rest/v1/detectionunits/{guid}/measures?fromDate={YYYY-MM-DDThh:mm:ss.sZ}&toDate={YYYY-MM-DDThh:mm:ss.sZ}
OMNIA -[#green]> TP: 200 OK (response also includes an array of {Measures})
note right : Message response in case of error are:\n401 Unauthorized\n500 Internal Server Error
@enduml
```

# Events sequence diagram

```plantuml
@startuml
skinparam BackgroundColor white
skinparam NoteBackgroundColor whitesmoke

participant "Third-party" as TP #white
participant "OMNIA REST API" as OMNIA #white

TP -[#black]> OMNIA: GET /rest/v1/events/
OMNIA -[#green]> TP: 200 OK (response also includes an array of {SituationRecord})
OMNIA -[#red]> TP: 401 Unauthorized

@enduml
```

# Network state sequence diagram

```plantuml
@startuml
skinparam BackgroundColor white
skinparam NoteBackgroundColor whitesmoke

participant "Third-party" as TP #white
participant "OMNIA REST API" as OMNIA #white

TP -[#black]> OMNIA: GET /rest/v1/netstates/supportedmeasures/
OMNIA -[#green]> TP: for each measureType, the unit of measure and the legend of exportable shapfile
TP -[#black]> OMNIA: GET /rest/v1/netstates?measureType={}&shapeWidth={}&shapeHeigth={}&minLon={}&minLat={}&maxLon={}&maxLat \n to get a shpfile describing the network status in terms of "measure type", for the area inside defined Latitude ans Longitude (EPSG:4326)\nThe exported file is sized shapeWidth x shapeHeight

note left: measureType: flow, speed, traveltime,\n density, los , anomaly level , congestion level
OMNIA -[#green]> TP: 200 OK (response also includes an array of {NetSTATE})

OMNIA -[#red]> TP: 401 Unauthorized

@enduml
```