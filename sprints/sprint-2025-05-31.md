# Sprint 2025-05-31

## Analisi Funzionalità Matita/Canvas

### Funzionamento Attuale

1. **Inizializzazione del Canvas** (righe 983-1019)
   * Canvas nascosto creato al caricamento pagina
   * Classe `canvasForWriting` con z-index 100
   * Posizionamento assoluto sopra il contenuto
   * Event listener per mouse e scroll registrati

2. **Toggle della Matita** (righe 1022-1034)
   * `toggleMdCanvas()` attiva/disattiva modalità disegno
   * Attiva: gif animata + canvas visibile
   * Inattiva: immagine statica + canvas nascosto

3. **Gestione del Disegno** (righe 1057-1078)
   * Disegna solo se canvas disattivato (`!window.toggleCanvas`) e mouse premuto
   * Linee verdi (#2bc02d) spessore 5px

4. **Tracking Posizione** (righe 1036-1046)
   * `scrollPosition()`: aggiorna posizione scroll
   * `setPosition()`: calcola posizione mouse con fattori scala (1.01 e 1.014)

5. **Ridimensionamento** (righe 1048-1054)
   * `resize()`: adatta canvas a dimensioni finestra/documento

## Problemi Identificati e Miglioramenti

### 1. Bug nella Logica Toggle

* **Problema**: Inversione logica - disegno funziona quando `!window.toggleCanvas`
* **Soluzione**: Invertire la condizione per renderla intuitiva

### 2. Problema Fattore di Scala (PRIORITARIO) ✅

* **Problema**: Disallineamento verticale tra cursore e tratto che peggiora scrollando
* **Causa Identificata**:
  * La pagina è dentro un IFRAME nell'app Angular
  * Lo scroll non veniva aggiornato prima di ogni disegno
  * I fattori di scala hardcoded (1.01, 1.014) erano tentativi falliti di compensare
* **Soluzione Finale**:
  * Canvas con `position: absolute` per seguire il documento
  * Canvas dimensionato all'intero documento (`scrollWidth` x `scrollHeight`)
  * **Chiave**: Aggiornare `scrollPos` in `setPosition()` ad ogni movimento del mouse
  * Formula corretta: `pos = clientPos + scrollPos`
  * Rimossi tutti i fattori di scala arbitrari

### 3. Persistenza del Disegno

* **Problema**: Canvas si resetta al reload, nessun salvataggio
* **Soluzioni possibili**:
  * Salvare in localStorage
  * Inviare al server come immagine
  * Integrare con sistema markdown

### 4. Strumenti di Disegno Limitati ✅ PARZIALMENTE RISOLTO

* **Implementati**:
  * ✅ Tavolozza con 10 colori predefiniti
  * ✅ Gomma per cancellare (con globalCompositeOperation)
  * ✅ Slider per dimensione pennello (1-20px)
  * ✅ Feedback visivo per selezione colore/gomma
* **Ancora mancanti**:
  * Forme geometriche
  * Selezione colore personalizzato (color picker)

### 5. UX Miglioramenti

* **Problemi**:
  * Nessun feedback visivo modalità attiva
  * Cursore non cambia in modalità disegno
  * Manca pulsante cancella tutto
* **Soluzioni**:
  * Cambiare cursore a matita/pennello
  * Indicatore visivo stato attivo
  * Toolbar con controlli

### 6. Performance

* **Problemi**:
  * Resize perde contenuto canvas
  * Fattori scala potrebbero causare lag
* **Soluzioni**:
  * Salvare/ripristinare contenuto su resize
  * Ottimizzare calcoli posizione

### 7. Accessibilità

* **Mancano**:
  * Scorciatoie tastiera (es. Ctrl+D per toggle)
  * Supporto touch per tablet/mobile
  * Indicazioni screen reader

### 8. Integrazione Sistema

* **Problemi**:
  * Disegno non salvato con markdown
  * Non esportabile/condivisibile
* **Soluzioni**:
  * Salvare come allegato al documento
  * Esportare come PNG/SVG
  * Condividere tramite clipboard

## Piano di Lavoro

### Fase 1: Fix Fattore di Scala ✅ COMPLETATO

* ✅ Analizzata causa disallineamento verticale (IFRAME context)
* ✅ Rimossi fattori hardcoded
* ✅ Implementato calcolo corretto posizione (aggiornamento scrollPos in setPosition)

### Fase 2: Logica e UX Base ✅ PARZIALMENTE COMPLETATO

* ✅ Logica toggle corretta (canvas attivo quando toggleCanvas = false)
* ✅ Feedback visivo stato con classe 'active'
* ✅ UI modernizzata con gradiente, ombre e transizioni
* ✅ Riposizionamento in basso a sinistra per evitare sovrapposizione
* TODO: Cambio cursore a matita

### Fase 3: Strumenti Avanzati ✅ COMPLETATO

* ✅ Tavolozza colori con 10 colori predefiniti
* ✅ Gomma con globalCompositeOperation
* ✅ Selezione dimensione pennello (1-20px)
* ✅ Feedback visivo per colore/gomma selezionati

### Fase 4: Persistenza

* TODO: Salvare in localStorage
* TODO: Integrazione con sistema save

### Fase 5: Integrazione Completa

* TODO: Export immagini
* TODO: Salvataggio con markdown
* TODO: Condivisione

## Miglioramenti UI Implementati (2025-05-31)

### 1. Riposizionamento Strategico

* Barra strumenti spostata da centro a sinistra (bottom: 20px, left: 20px)
* Tavolozza colori rimane centrata
* Eliminata completamente la sovrapposizione

### 2. Design Moderno

* Background: gradiente lineare bianco-grigio chiaro
* Bordi: sottili con rgba per trasparenza
* Ombre: box-shadow multipli per profondità
* Border-radius: aumentato a 24px per look più moderno
* Padding: aumentato per migliore spaziatura

### 3. Feedback Visivo

* Hover: solleva pulsanti di 2px e aumenta ombra
* Active: riporta pulsante a posizione normale
* Icone: scale(1.1) su hover per ingrandimento sottile
* Stato attivo: background verde (#4CAF50) e icona bianca quando canvas è attivo
* Transizioni: smooth su tutti gli elementi (0.2-0.3s)

<br />
