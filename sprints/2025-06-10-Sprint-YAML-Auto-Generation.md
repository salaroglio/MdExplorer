# Sprint YAML Auto Generation

## üìã Obiettivo
Implementare l'aggiunta automatica dei metadati YAML quando vengono rilevati mancanti durante l'export in Word, utilizzando lo stesso formato generato durante la creazione di nuovi documenti.

## üéØ Contesto
- **Problema**: L'export in Word fallisce con `NullReferenceException` quando il documento non contiene metadati YAML
- **Soluzione**: Aggiungere automaticamente i metadati YAML mancanti usando lo stesso formato del template "Text document"

## üìù Piano di Implementazione

### Step 1: Analisi del formato YAML esistente ‚úÖ
**Completato**: Il formato YAML per "Text document" √®:
```yaml
---
author: <nome utente git>
document_type: Document
email: <email utente git>
date: <data corrente formato dd/MM/yyyy>
---
```

### Step 2: Creare un servizio per generare YAML di default
**File**: `MdExplorer.Features/Yaml/YamlDefaultGenerator.cs`

**Azioni**:
1. Creare interfaccia `IYamlDefaultGenerator`
2. Implementare la classe che:
   - Inietta `IGitService` per recuperare author/email
   - Genera YAML con struttura `MdExplorerDocumentDescriptor`
   - Include `WordSection` con valori di default per export

**Codice di esempio**:
```csharp
public interface IYamlDefaultGenerator
{
    string GenerateDefaultYaml();
    MdExplorerDocumentDescriptor GenerateDefaultDescriptor();
}
```

### Step 3: Modificare il parser YAML esistente
**File**: `MdExplorer.Features/Yaml/YamlDocumentDescriptorParser.cs`

**Azioni**:
1. Modificare `GetDescriptor` per:
   - Verificare se il documento contiene YAML
   - Se mancante, usare `IYamlDefaultGenerator`
   - Restituire sempre un oggetto valido (mai null)

### Step 4: Aggiornare MdExportController per evitare Rule #1
**File**: `MdExplorer/Controllers/MdExportController.cs`

**Azioni**:
1. Iniettare `IYamlDefaultGenerator` nel costruttore del controller
2. Modificare il metodo `GetAsync` PRIMA di creare `StartPandoc`:
   - Verificare se il documento ha YAML valido
   - Se YAML mancante o `docDesc` √® null:
     - Generare YAML di default
     - **Disabilitare temporaneamente il FileSystemWatcher**
     - Aggiungere YAML al file originale
     - **Riabilitare il FileSystemWatcher**
     - Inviare notifica snackbar gialla via SignalR
     - Aggiornare `readText` con il contenuto modificato

**Codice esempio nel metodo GetAsync**:
```csharp
// Dopo aver letto il file e prima di StartPandoc
var docDesc = _yamlDocumentManager.GetDescriptor(readText);
if (docDesc?.WordSection == null)
{
    // YAML mancante o invalido
    var defaultYaml = _yamlDefaultGenerator.GenerateDefaultYaml();
    var updatedContent = defaultYaml + "\n" + readText;
    
    // Salva evitando il trigger del FileSystemWatcher
    _fileSystemWatcher.EnableRaisingEvents = false;
    try
    {
        File.WriteAllText(filePath, updatedContent);
        
        // Notifica via SignalR
        await _hubContext.Clients.Client(connectionId)
            .SendAsync("yamlAutoGenerated", new {
                message = "Metadati YAML aggiunti automaticamente",
                filePath = filePath
            });
    }
    finally
    {
        _fileSystemWatcher.EnableRaisingEvents = true;
    }
    
    // Usa il contenuto aggiornato
    readText = updatedContent;
}

// Ora StartPandoc avr√† sempre un documento con YAML valido
var pandoc = new StartPandoc(new DocxPandocCommand(), _helperPdf, _yamlDocumentManager);
pandoc.StartNewPandoc(filePath, _fileSystemWatcher.Path, readText, out currentFilePdfPath, out processStarted);

### Step 5: Registrare il servizio nel DI container
**File**: `MdExplorer.Features/FeaturesDI.cs`

**Azioni**:
1. Registrare `IYamlDefaultGenerator` come Scoped
2. Verificare che `IGitService` sia disponibile

### Step 6: Aggiungere listener Angular per snackbar giallo
**File**: `MdExplorer/client2/src/app/signalR/services/server-messages.service.ts`

**Azioni**:
1. Aggiungere nuovo listener per evento `yamlAutoGenerated`
2. Mostrare snackbar giallo quando viene ricevuto l'evento

**Codice da aggiungere in `startConnection()`**:
```typescript
this.hubConnection.on('yamlAutoGenerated', (data) => {
  // Evento gestito nel componente che lo ascolta
  this.processCallBack(data, 'yamlAutoGenerated');
});
```

**File**: `MdExplorer/client2/src/app/md-explorer/components/toolbar/toolbar.component.ts`

**Nel constructor, aggiungere**:
```typescript
// Listener per YAML auto-generato
this.monitorMDService.addYamlAutoGeneratedListener(
  (data, objectThis) => {
    objectThis._snackBar.open(data.message, 'OK', {
      duration: 4000,
      verticalPosition: 'top',
      panelClass: ['warning-snackbar'] // Per stile giallo
    });
  }, this
);
```

**File**: `MdExplorer/client2/src/styles.scss`

**Aggiungere stile per snackbar giallo**:
```scss
.warning-snackbar {
  background-color: #fff3cd !important;
  color: #856404 !important;
  
  .mat-simple-snackbar-action {
    color: #856404 !important;
  }
}
```

### Step 7: Test e Validazione
**Test da eseguire**:
1. Export di un documento senza YAML ‚Üí deve funzionare e mostrare snackbar giallo
2. Export di un documento con YAML esistente ‚Üí non deve essere sovrascritto
3. Verificare che author/email vengano presi da Git config
4. Verificare che la data sia nel formato corretto
5. Verificare che il FileSystemWatcher non si attivi durante l'aggiunta di YAML
6. Verificare che lo snackbar giallo appaia con il messaggio corretto

## üîß Dettagli Tecnici

### Struttura WordSection di default
```yaml
word_section:
  write_toc: false
  template_section:
    template_type: default
    inherit_from_template: ""
    custom_template: ""
  document_header: ""
```

### Dipendenze necessarie
- `IGitService` - per recuperare author/email
- `IYamlParser<MdExplorerDocumentDescriptor>` - per parsing
- `YamlDotNet` - per serializzazione

### Configurazione YamlDotNet
```csharp
var serializer = new SerializerBuilder()
    .WithNamingConvention(UnderscoredNamingConvention.Instance)
    .Build();
```

## ‚ö†Ô∏è Note Importanti
1. Non sovrascrivere YAML esistente
2. Mantenere compatibilit√† con documenti esistenti
3. Il formato deve essere identico a quello generato da "Text document"
4. Gestire caso in cui Git config non sia disponibile (usare valori di default)

## üìä Criteri di Accettazione
- [x] Export Word funziona per documenti senza YAML
- [x] YAML viene aggiunto solo se mancante
- [x] Formato YAML identico a "Text document" template
- [x] Author/email presi da Git config
- [x] Data nel formato italiano (dd/MM/yyyy)
- [x] WordSection con valori di default per export
- [x] Nessuna regressione su documenti con YAML esistente
- [x] FileSystemWatcher non si attiva durante l'aggiunta YAML
- [x] Snackbar giallo appare con messaggio "Metadati YAML aggiunti automaticamente"

## üöÄ Riepilogo Implementazione

1. **Backend**:
   - Creare `IYamlDefaultGenerator` in Features
   - Iniettarlo in `MdExportController`
   - Verificare YAML prima di `StartPandoc`
   - Se mancante: disabilitare watcher ‚Üí aggiungere YAML ‚Üí riabilitare watcher
   - Inviare evento SignalR `yamlAutoGenerated`

2. **Frontend**:
   - Aggiungere listener in `server-messages.service.ts`
   - Mostrare snackbar giallo in `toolbar.component.ts`
   - Aggiungere stile CSS per snackbar warning

3. **Flusso**:
   - User clicca Export Word
   - Backend rileva YAML mancante
   - Backend aggiunge YAML senza triggerare Rule #1
   - Frontend mostra snackbar giallo
   - Export procede normalmente con YAML valido

## ‚úÖ Implementazione Completata

### File Creati/Modificati:

1. **Backend (.NET)**:
   - ‚úÖ `MdExplorer.bll/Yaml/IYamlDefaultGenerator.cs` - Interfaccia per generatore YAML
   - ‚úÖ `MdExplorer.bll/Yaml/YamlDefaultGenerator.cs` - Implementazione generatore YAML
   - ‚úÖ `MdExplorer.bll/FeaturesDI.cs` - Registrazione servizio nel DI container
   - ‚úÖ `MdExplorer/Controllers/MdExportController.cs` - Logica aggiunta YAML automatico

2. **Frontend (Angular)**:
   - ‚úÖ `client2/src/app/signalR/services/server-messages.service.ts` - Listener evento YAML
   - ‚úÖ `client2/src/app/md-explorer/components/toolbar/toolbar.component.ts` - Callback snackbar
   - ‚úÖ `client2/src/styles.scss` - Stile CSS snackbar giallo

### Funzionalit√† Implementate:
- ‚úÖ **Generazione YAML automatica** con formato identico a "Text document"
- ‚úÖ **Evitare Rule #1** disabilitando/riabilitando FileSystemWatcher
- ‚úÖ **Notifica utente** con snackbar giallo warning
- ‚úÖ **Author/Email** recuperati da configurazione Git
- ‚úÖ **WordSection** con valori di default per export
- ‚úÖ **Gestione errori** con fallback su valori di default

### Test Suggeriti:
1. Testare export di documento senza YAML
2. Verificare che non venga sovrascritto YAML esistente  
3. Controllare snackbar giallo con messaggio corretto
4. Verificare che Rule #1 non scatti durante l'aggiunta YAML